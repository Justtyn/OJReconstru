## 接口蓝图

------

## 一、鉴权 & 身份体系说明

角色建议统一成 3 个：

- `ROLE_ADMIN`  → admin 表
- `ROLE_TEACHER` → teacher 表
- `ROLE_STUDENT` → student 表

JWT 里至少要放：

- `userId`
- `role`
- `username`

所有 `/api/**` 接口默认都要带 `Authorization: Bearer <token>`，**只有登录、注册、公开列表允许匿名访问**。

------

## 二、认证 / 授权模块（Auth）

### 1. 登录相关（公开）

- `POST /api/auth/login`

  - 描述：统一登录入口，body 带 `role` 或 `loginType` 区分三种用户。

  - 请求：

    ```
    {
      "role": "student | teacher | admin",
      "username": "string",
      "password": "string"
    }
    ```

  - 响应：

    ```
    {
      "token": "jwt",
      "role": "student",
      "userId": 1988...,
      "username": "test01"
    }
    ```

  - 逻辑：

    - 按 role 查对应表（`student/teacher/admin`）re-oj 完全体
    - 校验密码
    - 写一条 `login_log`（success / fail_reason）
    - 返回 JWT

- `POST /api/auth/logout`

  - 描述：前端清 token + 记录 `login_log.logout_time`（可选，后台可以异步写）

### 2. 注册相关（可以只开放学生注册）

- `POST /api/auth/register/student`
  - 匿名可调用。
  - 根据 `student` 表字段插入新记录（用户名、邮箱唯一约束已在库里有了）。re-oj 完全体
  - 记录一条 `login_log`，`success=1`，`fail_reason='register_pending'` 或空（看你业务）。
- （可选）`POST /api/auth/register/teacher`
  - 一般不对外开放，交给 admin 在后台创建教师账号更安全。

### 3. 当前用户信息 / 修改个人信息（需要登录）

- `GET /api/auth/me`
  - 返回当前登录用户基本信息（根据 role 从对应表查）
- `PUT /api/auth/me/profile`
  - 学生：可改 `name / avatar / bio / school` 等
  - 教师：可改 `name / avatar / title` 等
- `PUT /api/auth/me/password`
  - 旧密码 + 新密码，修改对应表里的 password

------

## 三、用户管理模块（Admin / Teacher 用）

> 这一块很多接口你可以先用 MP 自动 CRUD 生成，然后放在 `/api/admin/**` 下，仅管理员 / 教师可以访问。

### 1. 学生管理（主要给 admin/teacher 后台）

- `GET /api/admin/students`（分页 + 条件）
- `GET /api/admin/students/{id}`
- `POST /api/admin/students`（后台创建）
- `PUT /api/admin/students/{id}`
- `DELETE /api/admin/students/{id}` 或 `PATCH /...` 设置禁用标记（看你需不需要）

### 2. 教师管理（管理员）

- 同上 `/api/admin/teachers` 系列 CRUD。

### 3. 管理员管理（超级管理员）

- `/api/admin/admins` 系列 CRUD（可选，看你有没有多管理员需求）

### 4. 登录日志查询（管理员）

- `GET /api/admin/login-logs`
  - 支持按 role / username / 时间范围筛选

------

## 四、公告模块（Announcement）

表：`announcement`（标题、内容、发布时间、置顶标记、上下线状态）

### 查询（学生 / 教师 / 管理员）

- `GET /api/announcements`
  - 参数：`page`、`size`、`pinnedOnly`、`keyword`
  - 默认只返回 `is_active=1` 的公告，先按置顶、后按发布时间倒序
- `GET /api/announcements/{id}`
  - 非激活公告仅管理员可见，其余角色视为 404

### 管理（仅管理员）

- `POST /api/admin/announcements`
- `PUT /api/admin/announcements/{id}`
- `DELETE /api/admin/announcements/{id}`
  - 以上接口需要 `ROLE_ADMIN`，可设置 `time/isPinned/isActive`。删除为硬删。

------

## 五、班级 / 加入班级模块（Classes）

表：`classes`、`classes_member`、`student.class_id`re-oj 完全体

### 教师端

- `POST /api/teacher/classes`
  - 创建一个班级，生成 `code`（加入码）
- `PUT /api/teacher/classes/{id}`
- `DELETE /api/teacher/classes/{id}`
- `GET /api/teacher/classes`
  - 查询自己创建/加入的班级列表
- `GET /api/teacher/classes/{id}/members`
  - 查看班级所有学生/教师成员

### 学生端

- `GET /api/student/classes`
  - 我所在的班级列表
- `POST /api/student/classes/join`
  - body：`{ "code": "SWEU2024" }`
  - 逻辑：
    - 根据 code 找到 `classes`
    - 在 `classes_member` 插入一条 student 记录
    - 可选：同时把 `student.class_id` 更新为这个班的“主班级”
- `POST /api/student/classes/leave/{classId}`（可选）
  - 退出班级：更新 `classes_member.left_at` / 删除这条关系

------

## 六、题库 & 测试用例模块（Problem）

表：`problem`（题面 / 示例）、`problem_testcase`（真实评测 I/O）

### 前台（学生）可用

- `GET /api/problems`
  - 查询参数：`page`、`size`、`keyword`（按 name 模糊）、`difficulty=easy|medium|hard`、`dailyChallenge`。
  - 默认仅返回 `is_active=1` 的题目，按 `create_time` 倒序。
- `GET /api/problems/{id}`
  - 返回题面的所有公开字段：描述、输入/输出描述、样例 I/O、时间/内存限制、提示等。
  - 若题目未启用，仅教师/管理员可访问，学生视为 404。

### 后台（教师 / 管理员）

- `POST /api/admin/problems`
  - body：`name`、`description`、`descriptionInput`、`descriptionOutput`、`sampleInput`、`sampleOutput`、`hint`、`dailyChallenge`、`difficulty`、`timeLimitMs`、`memoryLimitKb`、`source`、`isActive`。
  - 创建时自动将 `ac_count/submit_count=0`，`daily_challenge` 默认 `0`，`is_active` 默认 `1`。
- `PUT /api/admin/problems/{id}`
  - 同上请求体，更新题面信息；若 `isActive=false` 即下线题目。
- `DELETE /api/admin/problems/{id}`
  - 调用服务层删除题目，并同步清理 `problem_testcase` 中的所有用例，数据库外键也配置了 `ON DELETE CASCADE`。
- `GET /api/admin/problems/{id}/testcases`
  - 返回该题所有真实测试用例，仅后台可见。
- `POST /api/admin/problems/{id}/testcases`
  - body：`inputData`、`outputData`。
  - 可多次调用新增若干测试用例。
- `PUT /api/admin/problem-testcases/{testcaseId}`
  - body：`inputData`、`outputData`，仅修改对应记录。
- `DELETE /api/admin/problem-testcases/{testcaseId}`
  - 删除单个测试用例。

> 真实判题 I/O 只在 `problem_testcase` 表中维护，公开接口永远不给出。

------

## 七、作业模块（Homework）

表：`homework`、`homework_problem`re-oj 完全体

### 教师端

- `POST /api/teacher/homeworks`
  - body：`title, classId, startTime, endTime, description`
- `PUT /api/teacher/homeworks/{id}`
- `DELETE /api/teacher/homeworks/{id}`
- `POST /api/teacher/homeworks/{id}/problems`
  - body：`[problemId1, problemId2, ...]`
  - 往 `homework_problem` 里插多条
- `DELETE /api/teacher/homeworks/{id}/problems/{problemId}`
- `GET /api/teacher/classes/{classId}/homeworks`
  - 查看某班的作业列表
- `GET /api/teacher/homeworks/{id}/overview`
  - 作业概览：每题的 `ac_count / submit_count`（可由 `homework_problem` 维护或实时统计）
- `GET /api/teacher/homeworks/{id}/students/{studentId}/submissions`
  - 查看某个学生这次作业的做题情况

### 学生端

- `GET /api/student/classes/{classId}/homeworks`
  - 我所在班级的作业列表
- `GET /api/student/homeworks/{id}`
  - 详情：包括这次作业的题目列表（`homework_problem` + `problem`）
- `GET /api/student/homeworks/{id}/my-result`
  - 返回 “这次作业中我每道题的最新提交状态”：
    - problemId
    - latestSubmissionId
    - overallStatus (AC/WA/...)
    - score（如果你用）

------

## 八、判题 / 提交模块（核心）

表：`submission`、`submission_testcase_result`、`judge_status`、`submission_overall_status`re-oj 完全体

### 学生端

- `POST /api/submissions`

  - 功能：提交代码

  - body：

    ```
    {
      "problemId": "1988...",
      "homeworkId": "1988..." , // 可选，没有作业就不传或为 null
      "languageId": 54,
      "sourceCode": "int main() { ... }"
    }
    ```

  - 逻辑：

    1. 创建一条 `submission`（overall_status_id=1 PENDING，student_id 从 token 取）
    2. 查出该题所有 `problem_testcase`
    3. 每个用例调用 Judge0，得到 token
    4. 插入 `submission_testcase_result`（status 先设 1/2）
    5. 异步轮询 Judge0：
       - 更新 `submission_testcase_result.status_id/time/memory/stdout/...`
       - 统计通过个数 → 更新 `submission.passed_case_count / total_case_count / overall_status_id`
       - 更新 `student.ac / submit`、`problem.ac_count / submit_count`、`homework_problem.ac_count / submit_count`

- `GET /api/submissions/{id}`

  - 返回一次提交的完整详情（包含测试用例结果）：

    ```
    {
      "id": "1988...",
      "problemId": "1988...",
      "homeworkId": "1988...",
      "studentId": "1988...",
      "languageId": 54,
      "overallStatus": {
        "id": 3,
        "code": "ACCEPTED",
        "name": "通过"
      },
      "passedCaseCount": 3,
      "totalCaseCount": 3,
      "cases": [
        {
          "testcaseId": "1988...",
          "status": {
            "id": 3,
            "code": "ACCEPTED",
            "descriptionZh": "通过"
          },
          "timeUsed": 0.012,
          "memoryUsed": 1234,
          "stdout": "...",
          "stderr": null,
          "compileOutput": null,
          "message": null
        }
      ],
      "createdAt": "..."
    }
    ```

- `GET /api/problems/{problemId}/my-submissions`

  - 当前学生在这道题上的所有提交（分页）

- `GET /api/homeworks/{homeworkId}/my-submissions`

  - 当前学生在这次作业所有题的所有提交（或只返回每题最新一次）

### 教师 / 管理端

- `GET /api/admin/problems/{problemId}/submissions`
  - 查看所有同学做这道题的提交（支持按班级筛选）
- `GET /api/teacher/homeworks/{homeworkId}/submissions`
  - 查看这次作业所有提交列表
- `POST /api/admin/submissions/{id}/rejudge`（可选）
  - 重判某次提交

------

## 九、讨论 & 评论模块（Discussion）

表：`discussion`、`discussion_comment`re-oj 完全体

### 讨论主题

- `GET /api/discussions`
  - 可按 `problemId` 过滤
- `GET /api/discussions/{id}`
- `POST /api/discussions`
  - 仅登录学生可发：body 包含 `problemId`（可选）、`title`、`content`
- `PUT /api/discussions/{id}`
  - 作者本人 或 管理员可改
- `DELETE /api/discussions/{id}`
  - 作者本人 或 管理员可删

### 评论

- `GET /api/discussions/{id}/comments`
- `POST /api/discussions/{id}/comments`
  - body：`content` + 可选 `parentCommentId`、`replyToUserId`
- `DELETE /api/discussion-comments/{id}`
  - 作者 / 管理员可删

------

## 十、题解模块（Solution）

表：`solution`（student_id、problem_id、title、content、language、is_active、create_time）

### 查询

- `GET /api/solutions`
  - 参数：`page`、`size`、`problemId`、`authorId`、`includeInactive(仅admin)`
  - 角色：学生 / 教师 / 管理员均可访问。
- `GET /api/problems/{problemId}/solutions`
  - 同上，但强制过滤到指定题目并校验题目存在。
- `GET /api/solutions/{id}`
  - 未启用题解仅作者本人或管理员可看，其余角色 404。

### 写作 / 管理

- `POST /api/problems/{problemId}/solutions`
  - 仅学生可调用；Body：`title`、`content`、`language`、可选 `isActive`。
- `PUT /api/solutions/{id}`
  - 作者或管理员可修改：可调整标题/内容/语言/是否启用，支持切换题目（需要题目存在）。
- `DELETE /api/solutions/{id}`
  - 作者或管理员可删除；管理员可跨用户删除。

> 可选业务：仅允许 AC 过该题的学生发题解，可在 Service 层扩展校验。

------

## 十一、权限控制（简单规则整理）

你可以按下面规则在 Spring Security 里配置：

- 匿名可访问：
  - `POST /api/auth/login`
  - `POST /api/auth/register/student`
  - `GET /api/announcements`、`GET /api/announcements/{id}`
  - （可选）部分公开题目 `GET /api/problems` / `{id}`
- `ROLE_STUDENT`：
  - `/api/auth/me/**`
  - `/api/student/**`
  - `/api/submissions/**`（提交 + 查看自己的）
  - `/api/discussions/**`（发帖/评论）
  - `/api/problems/**`（题目列表/详情，不能改）
- `ROLE_TEACHER`：
  - `/api/teacher/**`
  - 有些 `/api/admin/**` 里可以只读或部分写（看你需要）
- `ROLE_ADMIN`：
  - `/api/admin/**` 全部
  - 可以查看所有人的提交、日志、用户等
