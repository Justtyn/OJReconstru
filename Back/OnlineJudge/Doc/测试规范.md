# 测试规范（集成测试基线）

## 目标与范围
- 控制器改动必须配套端到端集成测试，覆盖鉴权、DTO 校验、业务分支以及统一 `ApiResponse` 返回格式。
- 默认使用 `@SpringBootTest + MockMvc`，数据源为 H2 + `schema-test.sql`，与生产结构保持一致；必要时可对 Service 层补充单元测试，但不能替代控制器集成用例。

## 基础约束
1. **鉴权统一**：所有需要登录的请求必须通过注册/登录流程获取合法 `Authorization: Bearer ...` 头，禁止伪造请求属性。
2. **数据隔离**：每个测试自行构造数据，生成唯一的用户名/邮箱（如追加 `System.nanoTime()`）；严禁依赖固定 ID 或共享种子数据。
3. **副作用确认**：对密码/验证码/上传等操作，需通过后续调用或数据库状态验证副作用生效，并检查敏感字段不会泄露（如 `details.password`）。
4. **回收策略**：测试完成后应通过 API 或自动回滚回收新建数据；若依赖 H2 初始化脚本，则需保证每条记录对其他用例无影响（使用唯一约束即可）。

## 基建要求
- 引入 `ControllerTestSupport` 抽象基类，集中注入 `MockMvc` / `ObjectMapper`，并提供注册、登录、唯一字符串工具，避免各测试重复样板代码。
- 基类需线程安全（如基于 `AtomicInteger` 生成后缀），以便未来并行执行测试。
- 常见操作（构造请求、封装断言、上传文件等）优先沉淀到基类或专用 util。

## 覆盖的关键场景
1. **Auth 模块**
   - 注册（成功/重复），三种角色登录，`/auth/users/me`，注销更新日志，学生改密与找回密码流程（发送验证码、提交验证码），错误路径（账号不存在、旧密码错误、未绑定邮箱）。
2. **教务/日志模块**
   - 学生/教师/管理员/班级/班级成员的分页、详情、CRUD 正常路径；至少一次 401/404/400 分支验证 DTO 校验与权限拦截。
3. **文件上传**
   - 正方形图片成功，非正方形或非法格式失败；校验返回的 URL 前缀等于配置。
4. **题库 & 测试用例**
   - 匿名访问 `GET /api/problems` / `{id}` 可获取启用题目；未启用题目返回 404。
   - 教师/管理员角色可通过 `/api/admin/problems` CRUD，并验证删除题目后 `problem_testcase` 记录被清空。
   - `/api/admin/problems/{id}/testcases` 及 `/api/admin/problem-testcases/{testcaseId}` 的成功与鉴权失败路径。
5. **公告 / 题解 / 作业 / 讨论**
   - 管理员独占 `/api/admin/announcements` 的写操作，其余角色调用返回 403；教师/学生可列表 + 查看详情。
   - 学生创建题解、作者/管理员更新删除、其他学生/教师无权写；管理员查看下线题解、普通用户 404。
   - 作业：教师或管理员创建（需携带 `problemIds`）、更新、删除作业；学生仅能 GET 列表/详情/题目；作业题目增删接口校验权限、题目存在性以及班级归属。
   - 讨论：学生可创建/评论/删除自己的讨论或评论，管理员可操作全部；应覆盖 `GET /api/discussions`、`POST/PUT/DELETE /api/discussions` 及评论增删的权限分支。

## 执行与报告
- 统一通过 `./gradlew test` 运行，必要时在 CI 中附 `build/reports/tests/test/index.html`。
- 若新增脚本或环境依赖（如外部服务 Mock），需在 README/ProjectDesc 中同步说明。
